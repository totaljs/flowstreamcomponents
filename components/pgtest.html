<script total>

	exports.id = 'pgtest';
	exports.name = 'PostgreSQL';
	exports.icon = 'ti ti-database';
	exports.author = 'Peter Å irka | Total.js';
	exports.version = '1';
	exports.group = 'Checks';
	exports.config = { connection: 'postgresql://user:pass@hostname:5432/database', sql: 'SELECT 1', error: 'PostgreSQL error: {0}' };
	exports.inputs = [{ id: 'input', name: 'Test' }];
	exports.outputs = [{ id: 'error', name: 'Error' }];

	exports.npm = ['querybuilderpg'];

	exports.make = function(instance, config) {

		let status = { online: false, error: '' };

		instance.message = function($) {

			if (!config.connection) {
				status.online = false;
				status.error = 'No connection string';
				instance.status(status);
				$.send('error', config.error.format(status.error));
				return;
			}

			let Pg = require('pg');
			let client = new Pg.Client({ connectionString: config.connection });
			client.connect(function(err, client) {

				if (err) {
					status.online = false;
					status.error = err.stack;
					instance.status(status);
					$.send('error', config.error.format(status.error));
					return;
				}

				client.query(config.sql, function(err) {
					status.online = !err;
					status.error = err ? err.stack : null;
					instance.status(status);
					if (err)
						$.send('error', config.error.format(status.error));
					else
						$.destroy();
					client.end();
				});
			});

		};

	};

</script>

<readme>
This component checks PostgreSQL database connection.
</readme>

<settings>
	<div class="padding">
		<ui-component name="input" path="?.connection" config="monospace:1;required:1" class="m">Connection string</ui-component>
		<ui-component name="input" path="?.sql" config="monospace:1;required:1" class="m">SQL statement</ui-component>
		<ui-component name="input" path="?.error" config="monospace:1;required:1" class="m">Error message format</ui-component>
	</div>
</settings>

<style>
	.CLASS ui-bind { padding: 10px; font-size: 12px; border-top: 1px solid rgba(0,0,0,0.1); }
</style>

<body>
	<header>
		<i class="$ICON"></i>$NAME
	</header>
	<ui-bind path="$STATUS" config="template;show" class="block">
		<script type="text/html">
			{{ if value.online }}<div class="badge badge-green" style="width:100%">ONLINE</div>{{ else }}<div class="red">{{ value.error }}</div>{{ fi }}
		</script>
	</ui-bind>
</body>